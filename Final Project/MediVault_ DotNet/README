# MediVault - ASP.NET Core Backend

A robust healthcare management API built with ASP.NET Core 9.0, Entity Framework Core, and MySQL.

## ğŸš€ Quick Start

### Prerequisites
- .NET 9.0 SDK or later
- MySQL Server 5.7+
- Visual Studio 2022 or VS Code

### Setup Instructions

1. **Clone and navigate to project**:
   ```bash
   cd MediVault.Backend
   ```

2. **Configure Database Connection**

   Update `appsettings.json`:
   ```json
   {
     "ConnectionStrings": {
       "DefaultConnection": "Server=localhost;Database=MediVault;User=root;Password=your_password;Port=3306;"
     },
     "Jwt": {
       "Key": "your-secret-key-here"
     },
     "Smtp": {
       "Host": "smtp.gmail.com",
       "Port": 587,
       "Username": "your-email@gmail.com",
       "Password": "your-app-password"
     }
   }
   ```

3. **Restore NuGet Packages**:
   ```bash
   dotnet restore
   ```

4. **Apply Database Migrations**:
   ```bash
   dotnet ef database update
   ```

5. **Run the Application**:
   ```bash
   dotnet run
   ```

   API will be available at: `http://localhost:5000`
   Swagger UI: `http://localhost:5000/swagger`

## ğŸ“¦ Dependencies

| Package | Version | Purpose |
|---------|---------|---------|
| Pomelo.EntityFrameworkCore.MySql | 9.0.0 | MySQL database provider |
| Microsoft.AspNetCore.Authentication.JwtBearer | 9.0.0 | JWT authentication |
| Swashbuckle.AspNetCore | 10.1.0 | API documentation |
| iTextSharp.LGPLv2.Core | 3.7.12 | PDF generation |
| RestSharp | 107.3.0 | HTTP client |

## ğŸ—ï¸ Project Structure

```
MediVault.Backend/
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ AdminController.cs          # Admin operations
â”‚   â”œâ”€â”€ AuthController.cs           # Authentication
â”‚   â”œâ”€â”€ DoctorController.cs         # Doctor operations
â”‚   â”œâ”€â”€ HospitalController.cs       # Hospital management
â”‚   â””â”€â”€ PatientController.cs        # Patient operations
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ User.cs                     # Base user model
â”‚   â”œâ”€â”€ Patient.cs                  # Patient profile
â”‚   â”œâ”€â”€ Doctor.cs                   # Doctor profile
â”‚   â”œâ”€â”€ Hospital.cs                 # Hospital profile
â”‚   â”œâ”€â”€ Appointment.cs              # Appointments
â”‚   â”œâ”€â”€ Consultation.cs             # Consultations
â”‚   â”œâ”€â”€ Payment.cs                  # Payments
â”‚   â”œâ”€â”€ PatientFile.cs              # Medical files
â”‚   â””â”€â”€ OtpRecord.cs                # OTP management
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ EmailService.cs             # Email notifications
â”‚   â”œâ”€â”€ PdfService.cs               # PDF generation
â”‚   â””â”€â”€ PaymentService.cs           # Payment processing
â”œâ”€â”€ Data/
â”‚   â””â”€â”€ AppDbContext.cs             # Entity Framework context
â”œâ”€â”€ Migrations/                      # Database migrations
â”œâ”€â”€ Program.cs                       # Application startup
â”œâ”€â”€ appsettings.json                # Configuration
â””â”€â”€ MediVault.Backend.csproj        # Project file
```

## ğŸ” Authentication

JWT-based authentication with the following claims:
- User ID
- Email
- Role (Admin, Doctor, Patient, Hospital)
- Additional permissions

### Getting a Token

```bash
POST /api/auth/login
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password123"
}
```

Response:
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "user": {
    "id": "user-id",
    "email": "user@example.com",
    "role": "patient"
  }
}
```

### Using the Token

Include in request headers:
```
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

## ğŸ“š Key Controllers

### AuthController
- `POST /api/auth/register` - Register new user
- `POST /api/auth/login` - User login
- `POST /api/auth/refresh-token` - Refresh token
- `POST /api/auth/request-otp` - Request OTP for verification
- `POST /api/auth/verify-otp` - Verify OTP

### PatientController
- `GET /api/patients/{id}` - Get patient profile
- `PUT /api/patients/{id}` - Update patient profile
- `GET /api/patients/{id}/files` - Get patient medical files
- `POST /api/patients/{id}/files` - Upload medical file
- `GET /api/patients/{id}/appointments` - List patient appointments
- `GET /api/patients/{id}/consultations` - List consultations

### DoctorController
- `GET /api/doctors` - List all doctors
- `GET /api/doctors/{id}` - Get doctor profile
- `GET /api/doctors/{id}/consultations` - List doctor consultations
- `POST /api/doctors/access-request` - Request patient access
- `GET /api/doctors/access-requests` - List access requests

### HospitalController
- `POST /api/hospitals` - Register hospital
- `GET /api/hospitals/{id}` - Get hospital details
- `PUT /api/hospitals/{id}` - Update hospital
- `GET /api/hospitals/{id}/doctors` - List hospital doctors

### AdminController
- `GET /api/admin/users` - List all users
- `GET /api/admin/stats` - Get system statistics
- `PUT /api/admin/users/{id}/role` - Update user role
- `DELETE /api/admin/users/{id}` - Delete user account

## ğŸ’¾ Database Models

### User (Base Entity)
- Id (Guid)
- Email (string)
- PasswordHash (string)
- FirstName, LastName (string)
- Role (enum: Admin, Doctor, Patient, Hospital)
- CreatedAt, UpdatedAt (DateTime)

### Patient
- Id (Guid)
- UserId (FK)
- Age (int)
- Gender (string)
- BloodType (string)
- MedicalHistory (string)
- InsuranceProvider (string)

### Doctor
- Id (Guid)
- UserId (FK)
- HospitalId (FK)
- Specialization (string)
- LicenseNumber (string)
- Experience (int)
- Qualifications (string)

### Appointment
- Id (Guid)
- PatientId (FK)
- DoctorId (FK)
- ScheduledDate (DateTime)
- Status (enum: Pending, Confirmed, Completed, Cancelled)
- Notes (string)

### Consultation
- Id (Guid)
- PatientId (FK)
- DoctorId (FK)
- ConsultationDate (DateTime)
- Diagnosis (string)
- Prescription (string)
- Notes (string)

### Payment
- Id (Guid)
- PatientId (FK)
- Amount (decimal)
- PaymentDate (DateTime)
- Status (enum: Pending, Success, Failed)
- TransactionId (string)

## ğŸ”§ Configuration Files

### appsettings.json
```json
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=MediVault;User=root;Password=password;Port=3306;"
  },
  "Jwt": {
    "Key": "YourSuperSecretKeyThatIsAtLeast32CharactersLong"
  },
  "Smtp": {
    "Host": "smtp.gmail.com",
    "Port": 587,
    "Username": "your-email@gmail.com",
    "Password": "app-specific-password"
  },
  "AllowedHosts": "*"
}
```

### launchSettings.json
Modify to change default port and profile settings:
```json
{
  "profiles": {
    "http": {
      "commandName": "Project",
      "dotnetRunMessages": true,
      "applicationUrl": "http://localhost:5000"
    }
  }
}
```

## ğŸ“ API Examples

### Register User
```bash
curl -X POST http://localhost:5000/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "patient@example.com",
    "password": "SecurePassword123!",
    "firstName": "John",
    "lastName": "Doe",
    "role": "patient"
  }'
```

### Login
```bash
curl -X POST http://localhost:5000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "patient@example.com",
    "password": "SecurePassword123!"
  }'
```

### Book Appointment
```bash
curl -X POST http://localhost:5000/api/appointments \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{
    "doctorId": "doctor-id",
    "scheduledDate": "2025-02-15T10:00:00",
    "notes": "General checkup"
  }'
```

## ğŸš€ Database Migrations

### Creating a New Migration
```bash
dotnet ef migrations add MigrationName
```

### Updating Database
```bash
dotnet ef database update
```

### Reverting Migration
```bash
dotnet ef migrations remove
```

## ğŸ§ª Development

### Building the Project
```bash
dotnet build
```

### Running in Development Mode
```bash
dotnet run --configuration Development
```

### Publishing for Production
```bash
dotnet publish -c Release -o ./publish
```

## ğŸ“Š Logging

Logs are configured in `appsettings.json`. By default:
- **Information** level logs are recorded
- **Warning** level for Microsoft.AspNetCore namespace

Logs are output to console. Extend with file logging as needed.

## ğŸ”’ Security Features

- âœ… JWT token-based authentication
- âœ… Password hashing with strong algorithms
- âœ… Role-based access control (RBAC)
- âœ… CORS policy configuration
- âœ… Input validation
- âœ… Secure database connection
- âœ… OTP-based verification

## ğŸ› Troubleshooting

| Issue | Solution |
|-------|----------|
| **Connection failed** | Verify MySQL is running and connection string is correct |
| **Migration errors** | Delete pending migrations and run `dotnet ef database update` |
| **Port already in use** | Change port in `launchSettings.json` |
| **Authentication errors** | Ensure JWT key matches between appsettings.json |
| **CORS errors** | Add frontend URL to CORS policy in Program.cs |

## ğŸ“„ License

MIT License - See main README for details

---

For the complete project overview, see [../README.md](../README.md)
